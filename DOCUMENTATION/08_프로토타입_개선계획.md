# 프로토타입 개선 계획

## 🚨 현재 문제점 분석

엑셀 파일과 현재 프로토타입을 비교한 결과, **다수의 기능이 누락되거나 잘못 구현**되었습니다.

---

## ❌ 잘못된 부분

### 1. 시설규모 판정 로직 오류

**현재 (잘못됨):**
```javascript
if (emission >= 15) size = 'A';
else if (emission >= 2) size = 'B';
else size = 'C';
```

**올바른 로직 (엑셀 F5 셀):**
```javascript
// G5: 연간 GHG 배출량 (만ton/yr)
// B109=0, C109=5, B110=5, C110=50
if (0 <= emission && emission < 5) size = 'A';      // 5만톤 미만
else if (5 <= emission && emission < 50) size = 'B'; // 5~50만톤
else size = 'C';                                      // 50만톤 이상
```

---

### 2. 연료 상태 선택 기능 누락

**현재:** 연료 상태가 자동으로만 결정됨 (선택 불가)

**올바른 구현:**
- E12 셀은 **드롭다운** (Default / 고체 / 액체 / 기체)
- "Default" 선택 시: `VLOOKUP(C12, '_Law&GL22'!B36:U103, 19, 0)` 으로 자동 조회
- 다른 값 선택 시: 사용자가 선택한 값 그대로 사용

```javascript
// 연료 상태 옵션
const fuelStateOptions = ['Default', '고체', '액체', '기체'];

// 실제 적용값
function getActualFuelState(selectedState, fuelName) {
    if (selectedState === 'Default') {
        return FUEL_DATA[fuelName].defaultState;
    }
    return selectedState;
}
```

---

### 3. Tier 최소 기준 표시 누락

**현재:** Tier 최소 기준 없음

**올바른 구현 (D14, E14, F14 셀):**

| 시설규모 | 열량계수 (D14) | 배출계수 (E14) | 산화계수 (F14) |
|----------|---------------|---------------|---------------|
| A | T2 | T1 | T1 |
| B | T2 | T2 | T2 |
| C | T3 | T3 | T3 |

```javascript
function getMinTier(facilitySize) {
    switch(facilitySize) {
        case 'A': return { heat: 'T2', emission: 'T1', oxidation: 'T1' };
        case 'B': return { heat: 'T2', emission: 'T2', oxidation: 'T2' };
        case 'C': return { heat: 'T3', emission: 'T3', oxidation: 'T3' };
    }
}
```

**UI에 표시 필요:**
- 각 Tier 드롭다운 옆에 "(최소: T2)" 형식으로 표시
- 최소 기준 미달 시 경고 메시지

---

### 4. T3 직접입력 기능 누락

**현재:** T3 선택해도 입력란 없음

**올바른 구현:**
- T3 선택 시 **사용자 입력란 표시**
- D16, E16, F16 셀에 사용자가 직접 값 입력

```html
<!-- T3 선택 시 표시 -->
<div class="t3-input" id="heatT3Input" style="display: none;">
    <label>열량계수 직접입력 (MJ/kg)</label>
    <input type="number" id="heatT3Value" step="0.1">
</div>
```

**수식 반영:**
```javascript
// D20 (열량계수)
if (heatTier === 'T3') {
    heatValue = userInputD16;  // 사용자 입력값
} else {
    heatValue = VLOOKUP(fuel, tier);  // 테이블 조회
}
```

---

### 5. Scope 2 Tier 시스템 누락

**현재:** Scope 2에 Tier 없음

**올바른 구현 (D33, E33 셀):**

| 에너지원 | 전력 Tier (D33) | 열 Tier (E33) |
|----------|----------------|---------------|
| 전기(소비단) | T2 | - |
| 전기(발전단) | - | T3 |
| 열전용/열병합/열평균 | - | T3 |
| 지역난방 | - | T3 |

```javascript
function getScope2Tier(source) {
    if (source === '전기(소비단)') {
        return { power: 'T2', heat: '-' };
    } else {
        return { power: '-', heat: 'T3' };
    }
}
```

**T3 직접입력 (열):**
- E33이 T3일 때 배출계수 직접입력 가능
- E35 셀에 사용자 입력값 저장

---

### 6. 지역난방 상세 설정 미흡

**현재:** 지역과 계획기간 선택 UI 있지만 불완전

**올바른 구현 (G33, H33 셀):**

**지역 옵션 (G33):**
```javascript
const districtRegions = [
    '수도권지사',
    '충청지사', 
    '전북지사',
    '대구지사',
    '동서발전',
    '남부발전(동남권)',
    '남부발전(호남권)',
    '서부발전'
];
```

**계획기간 옵션 (H33):**
```javascript
const planPeriods = ['3기', '4기'];
// 3기: 2019-2023
// 4기: 2024-2028
```

**배출계수 조회 수식 (H34, H35, H36):**
```javascript
// H33(계획기간)에 따라 다른 테이블 참조
if (period === '3기') {
    coefs = VLOOKUP(region, _Supplier!B6:E21, col, 0);
} else {
    coefs = VLOOKUP(region, _Supplier!B14:E21, col, 0);
}
```

---

### 7. 산화계수 Tier 연동 누락

**현재:** 산화계수 Tier 개별 선택 가능

**올바른 구현 (F15 셀):**
```excel
=E15  // 산화계수 Tier = 배출계수 Tier
```

- 산화계수 Tier는 **배출계수 Tier와 자동 동일**
- UI에서 산화계수 Tier를 **비활성화** 또는 **자동 연동 표시**

---

## 📋 누락된 기능 목록

| # | 기능 | 현재 상태 | 우선순위 |
|---|------|----------|----------|
| 1 | 시설규모 판정 | ❌ 로직 오류 | 🔴 높음 |
| 2 | 연료 상태 선택 | ❌ 선택 불가 | 🔴 높음 |
| 3 | Tier 최소 기준 | ❌ 표시 없음 | 🔴 높음 |
| 4 | T3 직접입력 (Scope 1) | ❌ 구현 안됨 | 🔴 높음 |
| 5 | Scope 2 Tier | ❌ 구현 안됨 | 🔴 높음 |
| 6 | T3 직접입력 (Scope 2) | ❌ 구현 안됨 | 🟡 중간 |
| 7 | 산화계수 Tier 연동 | ❌ 개별 선택됨 | 🟡 중간 |
| 8 | 지역난방 3기/4기 | ⚠️ 불완전 | 🟡 중간 |
| 9 | GHG 종류 선택 (D12) | ❌ 구현 안됨 | 🟢 낮음 |

---

## 🔧 개선 계획

### Phase 1: 핵심 로직 수정 (필수)

1. **시설규모 판정 수정**
   ```javascript
   function getFacilitySize(emission) {
       if (emission < 5) return 'A';
       if (emission < 50) return 'B';
       return 'C';
   }
   ```

2. **Tier 최소 기준 추가**
   - 시설규모별 최소 Tier 계산
   - UI에 최소 기준 표시
   - 선택 시 유효성 검증

3. **T3 직접입력 구현**
   - T3 선택 시 입력란 표시/숨김
   - 입력값을 계산에 반영

### Phase 2: 연료 상태 & 산화계수 (중요)

4. **연료 상태 드롭다운**
   - Default + 고체/액체/기체 옵션
   - Default 시 자동 조회 로직

5. **산화계수 Tier 연동**
   - 배출계수 Tier와 자동 동일화
   - UI에서 읽기 전용으로 표시

### Phase 3: Scope 2 완성 (중요)

6. **Scope 2 Tier 시스템**
   - 전력 Tier / 열 Tier 분리
   - 에너지원에 따른 자동 설정

7. **Scope 2 T3 직접입력**
   - 열 배출계수 직접입력 기능

8. **지역난방 계획기간**
   - 3기 / 4기 선택
   - 기간별 다른 배출계수 테이블 참조

### Phase 4: 추가 기능 (선택)

9. **GHG 종류 선택**
   - D12: CO2 / CH4 / N2O 선택
   - 선택에 따른 개별 계산

---

## 📐 수정된 UI 구조

### Scope 1 섹션
```
┌─────────────────────────────────────────────────────────────┐
│ 🔥 Scope 1: 직접 배출                                       │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────────────────┐  ┌──────────────────────┐          │
│ │ 연료 정보            │  │ Tier 선택            │          │
│ ├──────────────────────┤  ├──────────────────────┤          │
│ │ 연료: [천연가스(LNG)]│  │ 열량: [T2 ▼] (최소:T2)│          │
│ │ 상태: [Default ▼]   │  │  └ 값: 49.4 MJ/kg    │          │
│ │       → 기체 (자동)  │  │  └ [T3입력: ___]     │          │
│ │ 사용량: [1]          │  │ 배출: [T2 ▼] (최소:T1)│          │
│ │ 단위: [ton ▼]       │  │  └ 값: 56,144 kg/TJ  │          │
│ │                      │  │  └ [T3입력: ___]     │          │
│ │                      │  │ 산화: T2 (=배출Tier)  │          │
│ │                      │  │  └ 값: 0.995         │          │
│ │                      │  │  └ [T3입력: ___]     │          │
│ └──────────────────────┘  └──────────────────────┘          │
│                                                              │
│ ┌───────────────────────────────────────────────────────────┐
│ │  CO2: 2.7596    CH4: 0.0002    N2O: 4.92e-6    합계: 2.77 │
│ └───────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────┘
```

### Scope 2 섹션
```
┌─────────────────────────────────────────────────────────────┐
│ ⚡ Scope 2: 간접 배출                                        │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────────────────┐  ┌──────────────────────┐          │
│ │ 에너지원             │  │ Tier / 배출계수      │          │
│ ├──────────────────────┤  ├──────────────────────┤          │
│ │ 구분: [전기(소비단)]▼│  │ 전력 Tier: T2        │          │
│ │ 사용량: [1]          │  │ 열 Tier: -           │          │
│ │ 단위: [MWh ▼]       │  │                      │          │
│ └──────────────────────┘  │ CO2: 456.7 kg/MWh    │          │
│                           │ CH4: 0.004 kg/MWh    │          │
│ ┌──────────────────────┐  │ N2O: 0.009 kg/MWh    │          │
│ │ 지역난방 설정 (숨김)  │  └──────────────────────┘          │
│ ├──────────────────────┤                                    │
│ │ 지역: [수도권지사 ▼] │                                    │
│ │ 계획기간: [4기 ▼]    │                                    │
│ │ 열 Tier: [T3 ▼]     │                                    │
│ │  └ [직접입력: ___]   │                                    │
│ └──────────────────────┘                                    │
│                                                              │
│ ┌───────────────────────────────────────────────────────────┐
│ │  CO2: 0.4567    CH4: 4e-6    N2O: 9e-6    합계: 0.4596   │
│ └───────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────┘
```

---

## 🗓️ 작업 일정

| 단계 | 내용 | 예상 시간 |
|------|------|----------|
| Phase 1 | 핵심 로직 수정 | 1-2시간 |
| Phase 2 | 연료 상태 & 산화계수 | 1시간 |
| Phase 3 | Scope 2 완성 | 1-2시간 |
| Phase 4 | 추가 기능 | 1시간 |
| 테스트 | 전체 검증 | 1시간 |

**총 예상 시간: 5-7시간**

---

## ✅ 완료 기준

1. 시설규모가 엑셀과 동일하게 판정됨
2. Tier 최소 기준이 표시되고 검증됨
3. T3 선택 시 직접입력이 가능함
4. 연료 상태를 선택하거나 Default로 자동 조회 가능
5. Scope 2에 Tier 시스템이 적용됨
6. 지역난방에서 지역과 계획기간을 선택 가능
7. 모든 테스트 케이스 통과

